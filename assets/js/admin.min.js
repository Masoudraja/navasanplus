jQuery(function(n){"use strict";function e(){return n("#mns-navasan-plus-formula-variables-container")}function t(){return n("#mns-navasan-plus-formula-components-container")}function a(){const n=e().data("currencies");if(Array.isArray(n))return n;try{return JSON.parse(String(n||"[]"))}catch(n){return[]}}function i(n){var e=n.attr("data-code");if(e)return e;var t=n.find('[name*="_mns_navasan_plus_formula_variables["]').first();if(t.length){var a=(t.attr("name")||"").match(/_mns_navasan_plus_formula_variables\[([^\]]+)\]/);if(a)return a[1]}return"v_0"}function r(n){return String(n).replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function o(e,t,a){a&&a!==t&&(e.find("[name],[id]").each(function(){var e=n(this),i=e.attr("name");i&&(i=i.replace(new RegExp("\\["+r(t)+"\\]","g"),"["+a+"]"),e.attr("name",i));var o=e.attr("id");o&&(o=(o=o.replace(new RegExp("_"+r(t)+"_","g"),"_"+a+"_")).replace(new RegExp("\\["+r(t)+"\\]","g"),"["+a+"]"),e.attr("id",o))}),e.find(".mns-var-code").text(a),e.find(".mns-copy-code, .mns-insert-code").attr("data-code",a).data("code",a),e.attr("data-code",a))}function s(){return"v_"+(Date.now().toString(36)+Math.floor(999*Math.random()).toString(36))}function l(){var t=new Set;e().children(".mns-formula-variable").each(function(){var e=n(this),a=i(e);if(!a||"v_0"===a||t.has(a)){var r=s();o(e,a||"v_0",r),t.add(r)}else e.attr("data-code",a),e.find(".mns-var-code").text(a),e.find(".mns-copy-code, .mns-insert-code").attr("data-code",a).data("code",a),t.add(a)})}function c(n){var e="currency"===(n.find('select[id$="_type"]').val()||"custom"),t=n.find('input[id$="_unit"]'),i=n.find('input[id$="_unit_symbol"]'),r=n.find('input[id$="_value"]'),o=n.find('input[id$="_value_symbol"]'),s=n.find('select[id$="_currency_id"]'),l=n.find(".mns-curr-rate");if(n.find(".mns-if-currency")[e?"show":"hide"](),e){t.attr("readonly","readonly"),r.removeAttr("readonly"),o.removeAttr("readonly");var c=s.find("option:selected"),u=(s.val()||"").toString(),d=parseFloat(c.data("rate")),m=c.data("symbol");if(isNaN(d)||!isFinite(d)||null==m)for(var f=a(),p=0;p<f.length;p++)if(String(f[p].id)===u){!isNaN(d)&&isFinite(d)||(d=parseFloat(f[p].rate)),null==m&&(m=f[p].symbol||"");break}if(!isNaN(d)&&isFinite(d)&&t.val(d),"string"==typeof m&&i.val(m),r.val()||r.val("1"),o.val()||"string"!=typeof m||o.val(m),l.length){var v=!isNaN(d)&&isFinite(d)?d.toLocaleString(void 0,{maximumFractionDigits:4}):"—";m&&(v+=" "+m),l.text(v)}}else t.removeAttr("readonly"),i.removeAttr("readonly"),r.removeAttr("readonly"),o.removeAttr("readonly")}function u(t,a){var r=e(),u=r.children(".mns-formula-variable");if(u.length){var d=u.last().clone(!0,!0);o(d,i(u.last()),s()),d.find("input, select, textarea").each(function(){var e=n(this);e.is(":checkbox,:radio")?e.prop("checked",!1):e.is("select")?e.prop("selectedIndex",0):e.val("")});var m=d.find('select[id$="_type"]');if(m.length&&m.val("currency"===t?"currency":"custom"),"currency"===t&&a){var f=d.find('select[id$="_currency_id"]');f.length&&a.currency_id&&f.val(String(a.currency_id)),a.name&&d.find('input[id$="_name"]').val(a.name),void 0!==a.unit&&d.find('input[id$="_unit"]').val(a.unit).attr("readonly","readonly"),a.unit_symbol&&d.find('input[id$="_unit_symbol"]').val(a.unit_symbol);var p=d.find('input[id$="_value"]');p.val()||p.val("1");var h=d.find('input[id$="_value_symbol"]');!h.val()&&a.unit_symbol&&h.val(a.unit_symbol)}var g=n('input[name="_mns_navasan_plus_formula_variables_counter"]');if(g.length){var x=parseInt(g.val()||"0",10);isNaN(x)||g.val(x+1)}return r.append(d),c(d),l(),v(),d}}n(document).on("click",".add-formula-variable",function(e){e.preventDefault(),"currency"===(n(this).data("kind")||"custom")?function(e){var t=a();if(t.length){var i=`\n  <div class="mnsnp-modal-backdrop" style="position:fixed;inset:0;background:rgba(0,0,0,.25);z-index:9999;"></div>\n  <div class="mnsnp-modal" style="position:fixed;left:50%;top:30%;transform:translateX(-50%);background:#fff;border:1px solid #ccd0d4;border-radius:6px;box-shadow:0 10px 30px rgba(0,0,0,.2);width:420px;z-index:10000;">\n    <div style="padding:14px 16px;border-bottom:1px solid #eee;font-weight:600;">${wp.i18n.__("Add Currency Variable","mns-navasan-plus")}</div>\n    <div style="padding:16px;">\n      <label style="display:block;margin-bottom:6px;">Select Currency</label>\n      <select class="mnsnp-curr-select" style="width:100%;">\n        <option value="0">${wp.i18n.__("— select —","mns-navasan-plus")}</option>\n        ${t.map(n=>`<option value="${n.id}" data-rate="${n.rate}" data-symbol="${n.symbol||""}">${n.label||"#"+n.id}</option>`).join("")}\n      </select>\n    </div>\n    <div style="padding:12px 16px;border-top:1px solid #eee;text-align:left;">\n      <button class="button button-primary mnsnp-curr-choose">${wp.i18n.__("Add","mns-navasan-plus")}</button>\n      <button class="button mnsnp-curr-cancel" style="margin-inline-start:6px;">${wp.i18n.__("Cancel","mns-navasan-plus")}</button>\n    </div>\n  </div>`,r=n('<div class="mnsnp-curr-picker-wrap"></div>').appendTo(document.body).html(i);r.on("click",".mnsnp-curr-cancel, .mnsnp-modal-backdrop",function(n){n.preventDefault(),r.remove()}),r.on("click",".mnsnp-curr-choose",function(n){n.preventDefault();var t=r.find(".mnsnp-curr-select option:selected"),a=t.val();if(a&&"0"!==a){var i=parseFloat(t.data("rate"))||0,o=t.data("symbol")||"",s=t.text();e({id:a,name:s,rate:i,symbol:o}),r.remove()}})}else alert(wp.i18n.__("No currencies found.","mns-navasan-plus"))}(function(n){u("currency",{currency_id:n.id,name:n.name,unit:n.rate,unit_symbol:n.symbol})}):u("custom",{})}),n(document).on("click",".remove-formula-variable",function(t){t.preventDefault();var a=e().children(".mns-formula-variable");if(a.length>1)n(this).closest(".mns-formula-variable").remove(),v();else{var i=a.eq(0);i.find("input, select, textarea").each(function(){var e=n(this);e.is(":checkbox,:radio")?e.prop("checked",!1):e.is("select")?e.prop("selectedIndex",0):e.val("")}),c(i),l(),v()}}),n(document).on("change",'#mns-navasan-plus-formula-variables-container select[id$="_type"]',function(){c(n(this).closest(".mns-formula-variable")),v()}),n(document).on("change",'#mns-navasan-plus-formula-variables-container select[id$="_currency_id"]',function(){c(n(this).closest(".mns-formula-variable")),v()}),n(document).on("click",".mns-copy-code",function(e){e.preventDefault();var t=n(this).attr("data-code")||n(this).data("code")||"";t&&function(e){if(navigator.clipboard&&navigator.clipboard.writeText)return navigator.clipboard.writeText(e);var t=n('<textarea style="position:fixed;left:-9999px;top:-9999px;"></textarea>').val(e).appendTo("body");t[0].select();try{document.execCommand("copy")}catch(n){}return t.remove(),Promise.resolve()}(t).then(()=>n(e.currentTarget).blur())}),n(document).on("click",".mns-insert-code",function(e){e.preventDefault();var t=n(this),a=t.attr("data-code")||t.data("code")||"",i=t.data("target")||t.attr("data-target")||"";if(a&&i){var r=n(i);r.length&&function(n,e){var t=n.get(0);if(t){if(t.focus(),"number"==typeof t.selectionStart){var a=t.selectionStart,i=t.selectionEnd,r=t.value;t.value=r.slice(0,a)+e+r.slice(i),t.selectionStart=t.selectionEnd=a+e.length}else document.selection&&document.selection.createRange?(t.focus(),document.selection.createRange().text=e):t.value+=e;n.trigger("input").trigger("change")}}(r,a)}});var d=window.FormulaParser&&FormulaParser.Parser?new FormulaParser.Parser:null;function m(){var t={};return e().children(".mns-formula-variable").each(function(){var e=n(this),a=i(e),r=parseFloat(e.find('input[id$="_unit"]').val()||"0"),o=parseFloat(e.find('input[id$="_value"]').val()||"0"),s=(isFinite(r)?r:0)*(isFinite(o)?o:0);isFinite(s)||(s=0),t[a]=s}),t}function f(n,e){if(!d||!n)return null;try{var t=d.evaluate(n,e||{});return isFinite(t)?t:null}catch(n){return null}}var p=null;function v(){d&&(clearTimeout(p),p=setTimeout(function(){var e;e=m(),t().children(".mns-formula-component").each(function(){var t=n(this),a=t.find('.mns-component-expression, [id$="_expression"], [name$="[expression]"], [name$="[text]"]').first(),i=t.find(".mns-component-total").first();if(a.length&&i.length){var r=f(a.val(),e);i.text(null===r?"—":r.toLocaleString(void 0,{maximumFractionDigits:4}));var o=t.find('input[name$="[symbol]"]').first(),s=t.find(".mns-component-total-symbol").first();s.length&&s.text(o.length&&o.val()?" "+o.val():"")}}),function(){var e=n("#mns_navasan_plus_formula_expression"),t=n(".mns-formula-live-row .mns-formula-total"),a=n(".mns-formula-live-row .mns-formula-error");if(e.length&&t.length){var i=String(e.val()||"").trim();if(!i)return t.text("—"),void(a.length&&a.hide().text(""));var r=m();try{var o=d?d.evaluate(i,r):null;"number"==typeof o&&isFinite(o)?(t.text(o.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})),a.length&&a.hide().text("")):t.text("—")}catch(n){t.text("—"),a.length&&a.text(n&&n.message?n.message:"Parse error").show()}}}(),function(){var e=m(),t=n('.mns-formula-expression textarea, [id$="_formula_expression"], [name$="[formula_expression]"]').first(),a=n(".mns-formula-expression-total").first();if(t.length&&a.length){var i=f(t.val(),e);a.text(null===i?"—":i.toLocaleString(void 0,{maximumFractionDigits:4}))}}()},150))}if(n(document).on("input change","#mns-navasan-plus-formula-variables-container input, #mns-navasan-plus-formula-variables-container select, #mns-navasan-plus-formula-variables-container textarea",v),n(document).on("input change",'#mns-navasan-plus-formula-components-container .mns-component-expression, #mns-navasan-plus-formula-components-container [id$="_expression"], #mns-navasan-plus-formula-components-container [name$="[expression]"]',v),n(document).on("input change","#mns_navasan_plus_formula_expression",v),n(document).on("input change",'.mns-formula-expression textarea, [id$="_formula_expression"], [name$="[formula_expression]"]',v),n(document).on("click",".add-formula-component",function(e){e.preventDefault();var a=t(),i=a.children(".mns-formula-component");if(i.length){var r=i.last().clone(!0,!0),o=function(e,t){var a=-1;return e.find(t).each(function(){n(this).find("input[name], select[name], textarea[name]").each(function(){var e=(n(this).attr("name")||"").match(/\[(\d+)\](?=\[[^\]]+\]$)/);if(e){var t=parseInt(e[1],10);!isNaN(t)&&t>a&&(a=t)}})}),a>=0?a+1:e.find(t).length}(a,".mns-formula-component");r.find("input, select, textarea").each(function(){var e=n(this),t=e.attr("name");t&&(t=t.replace(/\[(\d+)\](?=\[[^\]]+\]$)/,"["+o+"]"),e.attr("name",t)),e.is("select")?e.prop("selectedIndex",0):e.val("")}),r.find("[id]").removeAttr("id"),r.attr("data-index",o),a.append(r),v()}}),n(document).on("click",".remove-formula-component",function(e){e.preventDefault(),t().children(".mns-formula-component").length>1&&(n(this).closest(".mns-formula-component").remove(),v())}),"undefined"!=typeof inlineEditPost&&inlineEditPost&&inlineEditPost.edit){var h=inlineEditPost.edit;inlineEditPost.edit=function(e){h.apply(this,arguments);var t=0;if((t="object"==typeof e?parseInt(this.getId(e),10):parseInt(e,10))>0){var a=n("#post-"+t),i=n("#edit-"+t),r=function(n){return(a.find(n).text()||"").trim().replace(/[^\d.\-]/g,"")},o=r(".column-discount-profit-percentage"),s=r(".column-discount-profit-fixed"),l=r(".column-discount-charge-percentage"),c=r(".column-discount-charge-fixed");i.find("input.inline-edit-mns-discount-profit-percentage").val(o),i.find("input.inline-edit-mns-discount-profit-fixed").val(s),i.find("input.inline-edit-mns-discount-charge-percentage").val(l),i.find("input.inline-edit-mns-discount-charge-fixed").val(c)}}}l(),e().children(".mns-formula-variable").each(function(){c(n(this))}),v()});